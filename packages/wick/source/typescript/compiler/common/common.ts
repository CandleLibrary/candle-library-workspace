import { traverse } from "@candlelib/conflagrate";
import { Lexer } from "@candlelib/wind";
import { Node } from "../../types/all.js";
import { ComponentData } from './component.js';
import { ModuleHash } from "./hash_name.js";
import { Context } from './context.js';
import URI from '@candlelib/uri';
import { MODULE_FLAG } from './ModuleFlag';

/**
 * Set the givin Lexer as the pos val for each node
 * @param node 
 * @param pos 
 */
export function setPos<T>(node: T, pos: Lexer | any): T {

    if (!pos) {

        //console.warn("[pos] is null - this node will not render source maps correctly.");

    } else
        //@ts-ignore
        for (const { node: n } of traverse(node, "nodes"))
            //@ts-ignore
            n.pos = pos;

    return node;
}


export function addPendingModuleToContext(
    context: Context,
    resource_location: URI,
    requesting_source: URI,
): string {
    let url = getResolvedURI(resource_location, requesting_source);

    const hash = ModuleHash(url);

    const mod = context.repo.get(url);

    if (!mod)
        context.repo.set(url, {
            url: url,
            hash: hash,
            module: null,
            flag: 0
        });

    return hash;
}

function getResolvedURI(resource_location: URI, requesting_source: URI) {
    let resolved_uri = resource_location;
    let url = resolved_uri.toString();

    if (resource_location.IS_RELATIVE) {
        resolved_uri = <URI>URI.resolveRelative(resource_location, requesting_source);
        url = resolved_uri.toString();
    } else if (!resource_location.host) {
        url = resolved_uri.path;
    }
    return url;
}

export function addFlagToPendingModule(
    context: Context,
    resource_location: URI,
    requesting_source: URI,
    flag: MODULE_FLAG
) {

    let url = getResolvedURI(resource_location, requesting_source);

    const mod = context.repo.get(url);

    if (mod)
        mod.flag |= flag;
};

/** JS COMMON */
/**
 * Return the section source string corresponding to the given node
 * @param component - The component which contains the AST in which the node is a member.
 * @param node - Any AST node generated by the Wick parser.
 * @returns 
 */
export function getComponentSourceString(component: ComponentData, node: Node): string {

    const { pos } = node;

    //@ts-ignore
    return pos.slice();
}